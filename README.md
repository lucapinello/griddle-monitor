# Griddle Temperature Monitor

A real-time web app for monitoring griddle/grill temperature using **Tuya ZFX-WT01/WT02** WiFi temperature probes. Built with Flask, WebSockets, and Chart.js.

![Python](https://img.shields.io/badge/python-3.8+-blue.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

## Features

- **Real-time temperature display** - Fahrenheit/Celsius with live updates
- **Live temperature graph** - 30-minute history with smooth curves
- **Time-to-target prediction** - Estimates when you'll reach cooking temp
- **Configurable alarms**:
  - *Ready at* - notifies when griddle reaches target temperature
  - *Too hot* - warns when temperature exceeds safe limit
  - *Too low* - alerts if temperature drops below minimum
- **Audio + browser notifications** - Never miss an alarm
- **Mobile-friendly** - Responsive design works on phone/tablet/desktop
- **Wake lock** - Prevents phone from sleeping while monitoring
- **Auto-discovery** - Finds device IP automatically (handles DHCP changes)
- **Local communication** - Talks directly to device, no cloud required

## Raspberry Pi

For Raspberry Pi installation (including auto-start on boot), see **[RASPBERRY_PI.md](RASPBERRY_PI.md)**.

Includes fixes for:
- Raspbian Buster (Python 3.7) compatibility
- Systemd service for auto-start
- Archived repository issues

## Quick Start

### 1. Clone the repository

```bash
git clone https://github.com/lucapinello/griddle-monitor.git
cd griddle-monitor
```

### 2. Install dependencies

```bash
pip install -r requirements.txt
```

### 3. Configure your device

Run the TinyTuya wizard to get your device credentials:

```bash
python -m tinytuya wizard
```

You'll need:
- **Access ID** and **Access Secret** from [Tuya IoT Platform](https://iot.tuya.com/)
- Your device linked to the Tuya Smart or Smart Life app

This creates a `devices.json` file with your device credentials. The app reads this file automatically.

### 4. Start the server

```bash
python app.py
```

### 5. Open in browser

- **Local**: http://localhost:5001
- **From phone/tablet**: http://YOUR_COMPUTER_IP:5001

## Supported Devices

| Device | Sensor Type | Protocol | Temp Divisor |
|--------|-------------|----------|--------------|
| **ZFX-WT01** | K-type thermocouple | 3.5 | 1 (raw °C) |
| **ZFX-WT02** | NTC thermistor | 3.4 | 10 (value/10 = °C) |

The app auto-detects the device type from `devices.json` and applies the correct temperature conversion.

### Data Points (DPS)

| DPS | Description | Format |
|-----|-------------|--------|
| 101 | Temperature | Integer (divisor depends on device type) |
| 102 | Humidity | Integer, divide by 10 for % |
| 119 | Temperature unit | String: "c" or "f" |

## Device Selection

**The app automatically finds the first ZFX-WT01/WT02 temperature probe in `devices.json`** - no configuration needed!

If you have multiple temperature probes or need to override auto-detection, use these optional environment variables:

```bash
# Select by device name (partial match)
TUYA_DEVICE_NAME="WT01" python app.py

# Select by index (0-based)
TUYA_DEVICE_INDEX=1 python app.py

# Force device type (if auto-detection fails)
TUYA_DEVICE_TYPE="wt01" python app.py

# Override protocol version
TUYA_VERSION="3.5" python app.py

# Or provide credentials directly (bypasses devices.json)
TUYA_DEVICE_ID="your_id" TUYA_LOCAL_KEY="your_key" TUYA_DEVICE_TYPE="wt01" python app.py
```

For systemd service, add to `griddle-monitor.service`:

```ini
[Service]
Environment=TUYA_DEVICE_NAME=WT01
```

### Environment Variables Reference

| Variable | Description |
|----------|-------------|
| `TUYA_DEVICE_ID` | Device ID (bypasses devices.json) |
| `TUYA_LOCAL_KEY` | Local key (required with DEVICE_ID) |
| `TUYA_DEVICE_NAME` | Select device by name from devices.json |
| `TUYA_DEVICE_INDEX` | Select device by index (0-based) |
| `TUYA_DEVICE_TYPE` | Force type: `wt01` or `wt02` |
| `TUYA_VERSION` | Protocol version: `3.4` or `3.5` |

## Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  ZFX-WT01/02    │────▶│  Flask Backend  │────▶│  Browser UI     │
│  (Tuya device)  │     │  + WebSocket    │     │  (Chart.js)     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
   Local WiFi            Polls every 2s          Real-time updates
                         SocketIO events          via WebSocket
```

## File Structure

```
griddle-monitor/
├── app.py                    # Flask backend with WebSocket
├── tuya_explorer.py          # Device discovery/debugging tool
├── temp_probe.py             # Simple CLI temperature reader
├── requirements.txt          # Python 3.8+ dependencies
├── requirements-rpi.txt      # Python 3.7 (Raspberry Pi) dependencies
├── griddle-monitor.service   # Systemd service for auto-start
├── devices.json              # Device credentials (generated by wizard)
├── RASPBERRY_PI.md           # Raspberry Pi setup guide
├── templates/
│   └── index.html            # Main web page
└── static/
    ├── app.js                # Frontend JavaScript
    └── style.css             # Responsive styling
```

## Tuya IoT Platform Setup

1. Create a free account at [iot.tuya.com](https://iot.tuya.com/)
2. Create a Cloud Project:
   - Select "Smart Home" as the industry
   - Choose your data center region (us, eu, cn)
3. Subscribe to these APIs (Cloud → API Explorer → Subscribe):
   - IoT Core
   - Authorization
4. Link your Tuya Smart/Smart Life app:
   - Go to Devices → Link Tuya App Account
   - Scan the QR code with your mobile app
5. Run the TinyTuya wizard:
   ```bash
   python -m tinytuya wizard
   ```
   Enter your Access ID, Access Secret, and region when prompted.

## Troubleshooting

### Port 5000 in use (macOS)
macOS uses port 5000 for AirPlay. The app uses port 5001 instead.

### Device not responding
1. Run `python -m tinytuya scan` to check if device is visible
2. The app will automatically re-scan if it can't connect
3. Click "Rescan Network" button in the UI if needed

### Local key expired
If you reset or re-pair the device in the Tuya app, run the wizard again:
```bash
python -m tinytuya wizard
```

### Alarms not working on mobile
Mobile browsers require user interaction before playing audio. Tap anywhere on the page after loading to enable sounds.

### Temperature reading is wrong (e.g., 2.5°C instead of 25°C)
The app may have detected the wrong device type. Force the correct type:
```bash
# For ZFX-WT01 (K-type thermocouple) - no division needed
TUYA_DEVICE_TYPE="wt01" python app.py

# For ZFX-WT02 (NTC thermistor) - divide by 10
TUYA_DEVICE_TYPE="wt02" python app.py
```

## Tech Stack

- **Backend**: Python, Flask, Flask-SocketIO
- **Frontend**: HTML, CSS, JavaScript, Chart.js
- **Device Communication**: TinyTuya
- **Real-time Updates**: WebSocket (Socket.IO)

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

MIT License - see [LICENSE](LICENSE) for details.

## Acknowledgments

- [TinyTuya](https://github.com/jasonacox/tinytuya) - Local Tuya device communication
- [Chart.js](https://www.chartjs.org/) - Beautiful charts
- [NoSleep.js](https://github.com/richtr/NoSleep.js) - Wake lock for mobile
